% ==============================================
% Pattern Regognition Edition
% ==============================================

\NeedsTeXFormat{LaTeX2e}


% =========================== Basic packages ===========================
\RequirePackage{amsmath, amssymb, amsthm} % Math environments and symbols
\RequirePackage{geometry} % Page margins
\RequirePackage{fancyhdr} % Headers and footers
\RequirePackage{enumitem} % Custom lists
\RequirePackage{hyperref} % Clickable references
\RequirePackage{tikz} % For possible future diagrams
\RequirePackage{pgfplots}
\RequirePackage{xcolor} % Color support


% Use Package
\usepackage{sectsty}
\usepackage{etoolbox}
\usepackage{listings}
\usepackage{cancel}
\usepackage{xcolor}
\usepackage{xparse}
\usepackage{environ}
\usepackage{amssymb}
\usepackage{mathrsfs}
\usepackage{makecell}
\usepackage{mdframed}
\usepackage{booktabs}
\usepackage{arydshln}
\usepackage{pdfpages}
\usepackage[most]{tcolorbox}

\usepackage{pgfplots}
\pgfplotsset{compat=1.18}

\usepackage{amsmath}
\allowdisplaybreaks


% =========================== Page setup ===========================
\geometry{
  a4paper,
  left=3cm,
  right=3cm,
  top=3cm,
  bottom=3cm,
}
\sectionfont{\large}


% =========================== Header and footer setup ===========================
\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{}
\fancyhead[R]{\thepage}

\renewcommand{\footrulewidth}{0.4pt}

\newcommand{\currentsubject}{}

\newcommand{\subject}[1][2110573 - Pattern Recognition]{
  \renewcommand{\currentsubject}{#1}
  \fancyhead[L]{\textbf{#1}}
}

\newcommand{\currentfooter}{}

\newcommand{\setfooter}[1]{%
  \renewcommand{\currentfooter}{#1}%
  \fancyfoot[C]{\textbf{#1}}%
}

% =========================== Set paragraph spacing ===========================
\setlength{\parskip}{4pt}       % Space between paragraphs  


% =========================== Title command ===========================
\newcommand{\hwtitle}[5]{
  \begin{center}
    \ifx&#2&
      {\LARGE \bfseries Homework #1} \\[6pt]
    \else
      {\LARGE \bfseries #2} \\[6pt]
    \fi
    {\large #3} \\[2pt]
    {\small \text{#4}} \\
    \ifx&#5&
      %
    \else
      {\small \textit{Collaborators.} #5}%
    \fi
  \end{center}

  \ifx&#2&
    \setfooter{Homework #1}
  \else
    \setfooter{#2}
  \fi

  \vspace{12pt}
  \hrule
  \vspace{12pt}
}


% =========================== T environment ===========================
%Counter
\newcounter{Tproblem}
\renewcommand{\theTproblem}{\arabic{Tproblem}}

% Storage for used numbers
\newcommand{\usedTproblems}{}

% Recursive macro to find next unused number
\newcommand{\nextunusedTproblem}{
  \stepcounter{Tproblem}
  \edef\thisNum{\theTproblem}
  \ifinlist{\thisNum}{\usedTproblems}
    {\nextunusedTproblem} % continue recursion
    {} % stop if unused
}

\newenvironment{Tproblem}[1][]{
  \vspace{1em}
  \def\maybeNum{#1}
  \ifx\maybeNum\empty
    % auto mode
    \nextunusedTproblem
  \else
    % manual mode
    \setcounter{Tproblem}{\maybeNum}
    \edef\thisNum{\theTproblem}
    \ifinlist{\thisNum}{\usedTproblems}
      {\PackageWarning{Tproblem}{Problem number \thisNum\space already used in T environment; reusing it}}%
      {}
  \fi
  % Now record number only once
  \ifinlist{\thisNum}{\usedTproblems}{}{
    \listadd{\usedTproblems}{\thisNum}
  }
  % Typeset
  \par\noindent\textbf{T\thisNum. }\ignorespaces
}{
  \par\vspace{10pt}
}

% =========================== OT environment ===========================
%Counter
\newcounter{OTproblem}
\renewcommand{\theOTproblem}{\arabic{OTproblem}}

% Storage for used numbers
\newcommand{\usedOTproblems}{}

% Recursive macro to find next unused number
\newcommand{\nextunusedOTproblem}{
  \stepcounter{OTproblem}
  \edef\thisNum{\theOTproblem}
  \ifinlist{\thisNum}{\usedOTproblems}
    {\nextunusedOTproblem} % continue recursion
    {} % stop if unused
}

\newenvironment{OTproblem}[1][]{
  \vspace{1em}
  \def\maybeNum{#1}
  \ifx\maybeNum\empty
    % auto mode
    \nextunusedOTproblem
  \else
    % manual mode
    \setcounter{OTproblem}{\maybeNum}
    \edef\thisNum{\theOTproblem}
    \ifinlist{\thisNum}{\usedOTproblems}
      {\PackageWarning{OTproblem}{Problem number \thisNum\space already used in OT environment; reusing it}}%
      {}
  \fi
  % Now record number only once
  \ifinlist{\thisNum}{\usedOTproblems}{}{
    \listadd{\usedOTproblems}{\thisNum}
  }
  % Typeset
  \par\noindent\textbf{OT\thisNum. }\ignorespaces
}{
  \par\vspace{10pt}
}

% =========================== Common math shortcuts ===========================
\newcommand{\R}{\mathbb{R}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\N}{\mathbb{N}}

\newcommand{\abs}[1]{\left|#1\right|}
\newcommand{\norm}[1]{\left\lVert#1\right\rVert}
\newcommand{\set}[1]{\left\{#1\right\}}
\newcommand{\paren}[1]{\left(#1\right)}
\newcommand{\sqbracket}[1]{\left[#1\right]}


% =========================== Theorem styles ===========================
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

\theoremstyle{plain}
\newtheorem{theorem}{Theorem}[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}

\theoremstyle{remark}
\newtheorem*{remark}{Remark}


% =========================== Custom enumerate for subproblems ===========================
\newlist{subproblems_alpha}{enumerate}{2}
\setlist[subproblems_alpha]{
  label*=\alph*),
  ref=\alph*),
  wide=0pt,
  itemsep=2pt,
  parsep=0pt,
  leftmargin=*
}

% T problem based subproblems
\newlist{Tsubproblems}{enumerate}{2}
\setlist[Tsubproblems]{
  label*=T\arabic{Tproblem}.\arabic*,
  ref=T\arabic{Tproblem}.\arabic*,
  wide=0pt,
  itemsep=2pt,
  parsep=0pt,
  leftmargin=*
}

\newlist{Tsubsubproblems}{enumerate}{3}
\setlist[Tsubsubproblems]{
  label*=T\arabic{Tproblem}.\arabic{Tsubproblemsi}.\arabic*,
  ref=T\arabic{Tproblem}.\arabic{Tsubproblemsi}.\arabic*,
  wide=0pt,
  itemsep=2pt,
  parsep=0pt,
  leftmargin=*,
}

% OT problem based subproblems
\newlist{OTsubproblems}{enumerate}{2}
\setlist[OTsubproblems]{
  label*=OT\arabic{OTproblem}.\arabic*,
  ref=OT\arabic{OTproblem}.\arabic*,
  wide=0pt,
  itemsep=2pt,
  parsep=0pt,
  leftmargin=*
}

\newlist{OTsubsubproblems}{enumerate}{3}
\setlist[OTsubsubproblems]{
  label*=OT\arabic{OTproblem}.\arabic{OTsubproblemsi}.\arabic*,
  ref=OT\arabic{OTproblem}.\arabic{OTsubproblemsi}.\arabic*,
  wide=0pt,
  itemsep=2pt,
  parsep=0pt,
  leftmargin=*,
}

% =========================== Hyperref setup ===========================
\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  urlcolor=cyan,
  citecolor=blue,
}


% =========================== Solution ===========================
\newtcolorbox{solution}[1][]{
  enhanced,
  breakable,
  colback=gray!5!white,
  colframe=gray!75!black,
  fonttitle=\bfseries,
  title=Solution.\enspace,
  coltitle=gray!75!black,
  attach title to upper,
  boxed title style=colback=gray!25!white,
  #1,
}

% =========================== Proof ===========================
\newtcolorbox{proofbox}[1][]{
  enhanced,
  breakable,
  colback=blue!5!white,
  colframe=blue!75!black,
  fonttitle=\bfseries,
  title=\textit{Proof}.\enspace,
  coltitle=blue!75!black,
  attach title to upper,
  boxed title style=colback=blue!25!white,
  #1,
}
    
% =========================== Coding ===========================
\tcbuselibrary{listings,breakable,skins}

% Custom colors
\definecolor{codebg}{RGB}{240, 248, 255}
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{codeblue}{rgb}{0.25,0.35,0.75}

% Listings style
\lstdefinestyle{mycodingstyle}{
    language=Python,
    backgroundcolor=\color{codebg},
    basicstyle=\ttfamily\small,
    keywordstyle=\color{codeblue}\bfseries,
    commentstyle=\color{codegreen},
    stringstyle=\color{codepurple},
    numberstyle=\tiny\color{codegray},
    numbers=left,
    numbersep=8pt,
    stepnumber=1,
    frame=none,
    breaklines=true,
    breakatwhitespace=false,
    showstringspaces=false,
    keepspaces=true,
    captionpos=b,
    tabsize=2,
}

\newtcblisting{codingbox}[1][]{
  enhanced,
  breakable,
  colback=white,
  colframe=white,
  boxrule=0pt,
  width=0.9\linewidth,
  center,
  listing engine=listings,
  listing only,
  listing options={style=mycodingstyle,#1}
}

% =========================== Appendix inclusion ===========================

% Appendix title page style
\fancypagestyle{appendixtitle}{
  \fancyhf{}
  \fancyhead[L]{\textbf{\currentsubject}}
  \fancyhead[R]{\thepage}
  \fancyfoot[C]{\textbf{\currentfooter}}
  \renewcommand{\footrulewidth}{0.4pt}
}

% Appendix counter
\newcounter{myappendix}

\newcommand{\myappendix}[2]{%
    % #1 = path/to/file.pdf
    % #2 = appendix title (PDF name / description)

    \refstepcounter{myappendix}

    % ---------- Title page ----------
    \clearpage
    \thispagestyle{appendixtitle}

    \vspace*{\fill}
    \begin{center}
        {\Huge\bfseries APPENDIX~\arabic{myappendix}\par}
        \vspace{1.5em}
        {\huge #2\par}
    \end{center}
    \vspace*{\fill}

    \clearpage

    % ---------- PDF content ----------
    \includepdf[
        pages=-,
        pagecommand={},
    ]{#1}
}

% ==============================================
